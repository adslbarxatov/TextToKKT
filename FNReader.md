# FNReader v 7.11: руководство пользователя
> **ƒ** &nbsp;RD AAOW FDL; 31.12.2021; 15:05

# 1. Общие сведения

Модуль FNReader предназначен для чтения и обработки фискальных данных (ФД) из фискального накопителя (ФН).

Доступные функции:

1. Чтение данных из ФН с помощью физического или виртуального COM-порта и аппаратного адаптера (см. далее).

2. Формирование выгрузки архива ФН в формате ```.fnc``` ***в полном соответствии с пунктами 45 – 58 Приложения 2 к приказу
ФНС России «Форматы фискальных документов, обязательные к использованию» для версии ФФД 1.05***; выгрузки в ФФД 1.1 и 1.2
находятся в разработке;

3. Обработка фискальных данных:
    - Получение полного состояния и всех регистрационных данных ФН;
    - Получение отдельного документа ФН;
    - Получение полного отчёта по архиву ФН;
    - Получение контрольной ленты за отдельную смену;
    - Получение полного фискального (посменного) отчёта;
    - Получение посменного отчёта по диапазону дат.

4. Сохранение архива ФН в файл в формате:
    - Двоичных данных (доступен для последующего открытия и обработки в программе); это – внутренний формат программы (```.fsd```),
который не может быть использован при перерегистрации или снятии ККТ с учёта в личном кабинете ФНС.
    - Текстовой контрольной ленты (```.txt```);
    - Табличных данных (```.csv```, доступен для обработки в Microsoft Office Excel).

5. Выполнение обмена с ОФД с параметрами подключения, получаемыми автоматически по данным последней регистрации / перерегистрации;

6. Сброс МГМ (для технических целей);

7. Закрытие смены и архива ФН текущей датой или датой последнего документа ФН (на данный момент – только для ФФД 1.05);

8. Чтение выгрузок архивов ФН в форматах ```.fnc``` и ```.fsd```.

Чтение может быть выполнено тремя способами:
- ***Полное чтение архива***. По его завершении становятся доступными все функции обработки данных.
- ***Прямое чтение ФН***. В этом случае доступны функции чтения статуса ФН, отдельного документа
и контрольной ленты за смену (при условии, если функция поддерживается накопителем).
- ***Формирование выгрузки с последующей её загрузкой***. Функция позволяет самостоятельно формировать
файл выгрузки ФН, который (аналогично созданным в других программах) может быть открыт в FNReader.

Независимо от варианта и настроек чтения состояние ФН запрашивается в максимально полном виде.

Детализация чтения также может быть:
- ***Полной***. При этом из ФН считываются все основные текстовые (TLV) поля и квитанции подтверждения ОФД.
Может занимать продолжительное время. Наиболее старые версии ФН не поддерживают полную выгрузку.
- ***Краткой***. При этом считываются только суммовые счётчики, временны́е метки, номера, фискальные признаки
документов и состояния отправки ОФД. Выполняется быстрее полного считывания (примерно в два раза).

Работа программы протестирована на всех моделях ФН из [реестра ФНС](https://www.nalog.gov.ru/rn77/related_activities/registries/reestr_fiscal/).
При соблюдении производителями существующего аппаратного протокола чтения данных работа с будущими моделями ФН также будет возможна.
Поддержка версий ФФД 1.1 и более новых на данный момент находится в разработке; частичная поддержка уже доступна в релизной версии.

Для выполнения операций с ФН требуется наличие одного из следующих аппаратных адаптеров:
- COM-UART переходник для подключения ФН к разъёму COM (RS-232) компьютера;
- USB-VCOM-UART переходник для подключения к разъёму USB компьютера. В этом случае потребуется установить драйвера устройства;
инструкции и ссылки для их установки предоставляются производителями таких переходников.

Для работы модуля рекомендуется использовать операционную систему Windows 7 или более новую; функциональность приложения
на Windows XP не проверялась, но потенциально не ограничена. На ПК должна быть установлена среда
[.NET Framework 4.0](https://www.microsoft.com/ru-ru/download/details.aspx?id=17718) или более новая (обязательно при работе на Windows 7 и ниже).

> Обращаем внимание, что срок действия каждого релиза модуля ограничен с целью устранения устаревающих версий и обеспечения
> его постоянного соответствия актуальным изменениям в ФФД. Срок указан в заголовке операционного окна. По его истечении
> останутся доступными функции анализа ранее считанных данных. Для работы с новыми данными необходимо получить новый экземпляр приложения.

#

# 2. Начало работы (на примере VCOM-адаптера ООО «РИК»)

## 2.1. Подключение ФН и адаптера к ПК

Перед началом работы необходимо подготовить адаптер к работе. Порядок подключения следующий:
- Убедиться, что адаптер не подключён к ПК или другому источнику питания.
> Подключение и отключение ФН при наличии питания на адаптере может вывести оба устройства из строя!
- Подключить ФН к адаптеру. Обратите внимание на расположение «ключа» (пропущенного контактного штырька) на разъёмах ФН и адаптера.

![2](https://user-images.githubusercontent.com/20893717/147804726-54c1de33-80ed-4e46-a6a2-6ddd79aa4c51.png)

- Подключить адаптер к ПК.

Отключение по окончании работы с адаптером следует производить в обратном порядке:
- Отключить адаптер от ПК.
- Отключить ФН от адаптера.

> Отключение или переподключение адаптера при обращении к нему программы (определяется горящим или мигающим светодиодом
> на адаптере) запрещено! Это может вывести адаптер и ФН из строя!

Кроме того, при использовании USB-подключения для корректной и стабильной работы рекомендуются короткие соединительные
кабели (не длиннее 20 см) с сечением не менее 2,5 мм. Более длинные и/или тонкие кабели могут не обеспечивать достаточную
пропускную способность и/или уровень тока для некоторых моделей ФН (проверено на практике).

## 2.2. Установка драйвера устройства

После первого подключения адаптера к ПК может потребоваться установка драйвера. Драйвер для устройств FTDI VCP
доступен [здесь](http://www.ftdichip.com/Drivers/VCP.htm). Если драйвер упакован в архив, следует выполнить его распаковку в какую-либо папку.

Далее рассматривается установка драйвера на примере устройства FT230X Basic UART. Для установки драйвера необходимо выполнить следующие действия:
- В меню «Пуск» выбрать пункт «Выполнить» или нажать комбинацию клавиш [:window:] + [R].
- Ввести команду «compmgmt.msc» и нажать кнопку «ОК».
- В окне «Управление компьютером» в списке слева выбрать пункт «Диспетчер устройств». В списке устройств найти устройство «FT230X Basic UART»
(будет помечено значком ошибки).

![1](https://user-images.githubusercontent.com/20893717/147804389-f0a87ba5-cbd3-401e-825c-517af186607b.png)

- Щёлкнуть правой кнопкой мыши на этом устройстве и выбрать пункт «Обновить драйверы». В окне варианта установки выбрать «Выполнить поиск
драйверов на этом компьютере». В следующем окне нажать кнопку «Обзор» и указать папку, куда ранее были распакованы драйвера. Нажать кнопку «Далее».
- При необходимости проделать аналогичные манипуляции с устройством «USB Serial Converter» (если оно будет помечено значком ошибки).
- Найти в списке устройств раздел «Порты COM и LPT», а в нём – устройство «USB Serial Port». Запомнить номер порта; он потребуется для работы программы.

# 3. Работа с программой

С версии 7.7 модуль является частью инструмента [TextToKKT](https://github.com/adslbarxatov/texttokkt) для Windows. В его комплектацию
входят два файла – ```FNReader.dll``` и ```FNReaderLib.dll```. Отсутствие любого из них делает работу модуля невозможной. Запускать следует файл
```TextToKKT.exe```, из которого следует вызывать функцию FNReader.

Основной интерфейс модуля представлен на рисунке ниже.

![1](https://user-images.githubusercontent.com/20893717/147804740-130cdb1b-65f7-4892-9df3-9584e97a1b56.png)

## 3.1. Функции, доступные при запуске

- ***Выбрать номер порта подключения ФН***. Здесь необходимо выбрать порт, который соответствует устройству, появившемуся в системе
при установке драйверов (см. ранее). Если подключение устройства выполнено после запуска приложения, можно обновить список
системных портов ***кнопкой*** «✱».
- ***Подключить***. Запрашивает статус ФН и, если активен флажок «***и прочитать***» (будет иметь жёлтый цвет), запускает процесс
считывания данных из ФН. При этом будет отображено окно состояния чтения. На время считывания основное окно программы блокируется.
Если было выполнено полное считывание, по его завершении станут доступны аналитические функции программы.
Если процесс был прерван, или флажок «***и прочитать***» не был включён, аналитика будет недоступна, но станут активными функции
обмена с ОФД, прямого чтения и записи в ФН (при запуске неактивны).

![1](https://user-images.githubusercontent.com/20893717/147805842-f85e035f-163b-4dd5-a2f9-ee2248ff0520.png)

- ***Считать дамп***. Открывает ранее сохранённый файл дампа и позволяет выполнять с ним те же манипуляции, что и со считанными
данными ФН, открывая аналитический функционал. Функция поддерживает два формата файлов:
    - Собственный формат программы FNReader (v4 – v7, ```.fsd```);
    - Эталонный формат архива, создаваемый этой программой, а также программами FNArc, FNRun и FNTransfer (```.fnc```). На данный
    момент может не работать с выгрузками в ФФД 1.1 и 1.2.
Эта функция доступна также в варианте «*Открыть с помощью*»: если для открытия одного из этих файлов из операционной системы выбрать
программу TextToKKT, она выполнит их загрузку так же, как при нажатии кнопки «***Считать дамп***».

- ***Сформировать FNC***. Запускает процесс выгрузки архива ФН в формат, пригодный для передачи в ЛК ФНС при замене автономных ФН.
По завершении записи программа загрузит этот файл автоматически.

![1](https://user-images.githubusercontent.com/20893717/147806110-00f6c45d-d1bb-4ee6-9b02-1b7c1e14f09e.png)

- ***Изменить уровень детализации считывания (кнопка «Детали»)***. Переключатель указывает, будет ли выполняться считывание:
    - только базовых данных документов (*вариант «нет»*);
    - текстовых данных, подтверждений о получении фискальных документов от ОФД и фискальных признаков сообщений ОФД (*вариант «TLV»*);
    - всех доступных тегов, в том числе – неизвестных модулю FNReader в представлении hex (*вариант «все»*).
Включение детализации замедляет полный процесс чтения примерно в два раза, но позволяет просмотреть, например,
наименования реализованных товаров и услуг или имена кассиров.

- ***Обмен с ОФД***. Запускает отправку документов из ФН оператору фискальных данных (если очередь отправки не пуста). Для ФФД 1.1 и 1.2
поддержка реализована, но нуждается в «боевом» тесте; обмен с ИСМ пока не поддерживается. Настройки подключения определяются автоматически:
на данный момент для всех ОФД из реестра имеется однозначное соответствие «ИНН / Название ↔ Host name / IP + TCP port», которое позволяет
избавить пользователя от необходимости ручной настройки соединения. Программе известны настройки связи со всеми ОФД, действующими на 1 января 2022 года.
При запуске функции из ФН запрашивается длина очереди отправки и ИНН ОФД, после чего выполняется попытка подключения и отправки. В случае ошибки
FNReader сообщает, на каком шаге она происходит (т.е. была ли проблема в подключении, или подключение есть, но ОФД не принимает документ из-за
истечения тарифа). Если связь устанавливается, программа последовательно отправляет все документы из очереди (при необходимости процесс можно
прервать). По окончании передачи состояние ФН автоматически перезапрашивается.

- ***Включить/выключить прямое чтение***. Переключатель имеет оранжевый цвет, когда программа находится в режиме прямого чтения данных. В этом случае
доступны функции чтения статуса ФН, чтения и сохранения отдельного документа и контрольной ленты за смену. При этом полное считывание ФН и аналитический
функционал будут недоступны. Полнота считывания данных в этом режиме также определяется состоянием переключателя «***детали***».

- ***Разрешить запись в ФН***. Переключатель указывает, можно ли использовать функции, предполагающие запись данных в ФН (сброс МГМ, закрытие смены,
закрытие архива).
> Если Вы не знаете, зачем нужны эти функции, использовать их и включать эту опцию запрещено. Их применение требует внимания, т.к.
> результаты их работы необратимы. Все перечисленные функции выполняются пользователем на свой страх и риск.

- ***Сбросить МГМ***. Техническая операция; в основной работе не используется.

- ***Сохранить***. Функция позволяет сохранить содержимое поля статуса в текстовый файл независимо от его содержимого и состояния программы.

- ***Распечатать***. Позволяет отправить содержимое поля статуса на печать.

- ***Кнопка «Ассоциировать»***. Чтобы назначить FNReader в качестве постоянного обработчика форматов ```.fnc``` и ```.fsd```, следует
нажать эту кнопку. При этом необходимо, чтобы все файлы приложения находились в директории, в которой они будут находиться постоянно,
из которой они не будут перемещены в другое расположение.

- ***Кнопка «Выход»***. Закрывает окно FNReader.

## 3.2. Функции, доступные после полного считывания архива и в режиме прямого чтения

После полного считывания или в результате считывания дампа ФН становятся доступны функции ***сохранения отчётов***.
Сохранение выполняется в текстовых файлах; при этом пользователю будет предложено выбрать место сохранения и имя файла.

Также становится доступным ***сохранение дампа (архива) ФН***. В этом случае программа предложит в качестве имени файла
комбинацию из заводского номера ФН, заводского номера ККТ и наименования владельца ККТ. Сохранение возможно в любом
из трёх форматов (выбирается в окне сохранения файла):
- Табличный файл, доступный для обработки в Microsoft Office Excel;
- Бинарный файл, с которым возможна последующая работа в программе;
- Текстовый файл (классическая контрольная лента).

Кроме того, станут доступны некоторые ***интерактивные функции***; все они предполагают отображение сведений в текстовом поле в середине окна:
- По нажатию кнопки «***Показать счётчики***» будут отображены накопления за весь период работы ФН;
- При установке курсора и изменении значения в поле «***Номер документа***» будет отображено содержимое соответствующего документа.
Функция доступна также в режиме прямого чтения;
- При установке курсора и изменении значения в поле «***Номер смены***» будут отображены итоги соответствующей смены;
- При установке курсора в поле «COM-порт» и нажатии клавиши [Enter] выполняется повторное подключение к ФН;
- При нажатии кнопки «```i```» вновь отображается последний считанный статус ФН.

Наконец, если разрешена запись в ФН, станут доступными кнопки ***закрытия смены*** и ***закрытия архива ФН***, а также возможность
применения даты последнего документа ФН вместо текущей. Эти функции могут быть удобны, если по какой-либо причине закрытие
смены/архива в ККТ невозможно (например, исчерпание ресурса ФН при открытой смене).

> Если Вы не знаете, зачем нужны эти функции, использовать их запрещено. Их применение требует внимания, т.к. результаты
> их работы необратимы. Все указанные функции выполняются пользователем на свой страх и риск.

По завершении этих операций программа может быть автоматически переведена в режим прямого чтения для получения текстовых представлений
отчётов, сформированных ими. Также автоматически выполняется попытка их передачи ОФД.

# 4. Совместное использование с программами FNArc и FNTransfer

> Раздел устарел, но, несмотря на наличие собственной функции выгрузки у текущей версии приложения, остаётся возможным к применению.

Программа FNArc, разработанная ЗАО «Атлас-карт», программа FNTransfer, доступная в ЛК ФНС, и программа FNRun производства
[ctocas.ru](http://www.ctokas.ru) обеспечивают считывание архива ФН в полном соответствии с законодательством. Однако в некоторых
режимах работы приложения могут работать медленнее, чем программа FNReader. Кроме того, предусмотренная законом выгрузка представляет
собой двоичный файл, просмотреть который штатными средствами операционной системы или этими приложениями не представляется возможным.

В связи с этим предлагаются следующие два варианта использования программ FNReader и FNArc или FNTransfer:

1. ***Если выполняется работа с ФН, запущенным в автономном режиме (без передачи данных)***:
- Выполнить выгрузку архива в файл .fnc с помощью программы FNArc или FNTransfer. Это займёт не более 10 минут (≈ 1 минута
на каждые 10’000 документов), т.к. программы используют недокументированные возможности ФН;
- Сохранить этот файл для дальнейшей передачи и обработки в ФНС;
- При необходимости открыть этот файл в программе FNReader. Вся информация из архива, а также аналитические функции будут доступны
в понятном для человека виде.

2. ***Если выполняется работа с ФН, запущенным в режиме передачи данных ОФД***:
- Выполнить прямое чтение документа или отдельной смены программой FNReader, если количество документов слишком велико 
для полного считывания. Эта функция может не работать при номерах документов свыше 20’000 и на некоторых версиях ФН.
- Или выполнить полное чтение архива программой FNReader, если документов небольшое количество (до 1000). Для ускорения
процесса можно отключить детализацию; суммовые счётчики и статус ФН будут доступны в любом случае.
