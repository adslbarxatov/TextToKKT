# FNReader v 7.11: руководство пользователя
> **ƒ** &nbsp;RD AAOW FDL; 31.12.2021; 15:05

# 1. Общие сведения

Модуль FNReader предназначен для чтения и обработки фискальных данных (ФД) из фискального накопителя (ФН).

Доступные функции:

1. Чтение данных из ФН с помощью физического или виртуального COM-порта и аппаратного адаптера (см. далее).

2. Формирование выгрузки архива ФН в формате ```.fnc``` ***в полном соответствии с пунктами 45 – 58 Приложения 2 к приказу
ФНС России «Форматы фискальных документов, обязательные к использованию» для версии ФФД 1.05***; выгрузки в ФФД 1.1 и 1.2
находятся в разработке;

3. Обработка фискальных данных:
    - Получение полного состояния и всех регистрационных данных ФН;
    - Получение отдельного документа ФН;
    - Получение полного отчёта по архиву ФН;
    - Получение контрольной ленты за отдельную смену;
    - Получение полного фискального (посменного) отчёта;
    - Получение посменного отчёта по диапазону дат.

4. Сохранение архива ФН в файл в формате:
    - Двоичных данных (доступен для последующего открытия и обработки в программе); это – внутренний формат программы (```.fsd```),
который не может быть использован при перерегистрации или снятии ККТ с учёта в личном кабинете ФНС.
    - Текстовой контрольной ленты (```.txt```);
    - Табличных данных (```.csv```, доступен для обработки в Microsoft Office Excel).

5. Выполнение обмена с ОФД с параметрами подключения, получаемыми автоматически по данным последней регистрации / перерегистрации;

6. Сброс МГМ (для технических целей);

7. Закрытие смены и архива ФН текущей датой или датой последнего документа ФН (на данный момент – только для ФФД 1.05);

8. Чтение выгрузок архивов ФН в форматах ```.fnc``` и ```.fsd```.

Чтение может быть выполнено тремя способами:
- ***Полное чтение архива***. По его завершении становятся доступными все функции обработки данных.
- ***Прямое чтение ФН***. В этом случае доступны функции чтения статуса ФН, отдельного документа
и контрольной ленты за смену (при условии, если функция поддерживается накопителем).
- ***Формирование выгрузки с последующей её загрузкой***. Функция позволяет самостоятельно формировать
файл выгрузки ФН, который (аналогично созданным в других программах) может быть открыт в FNReader.

Независимо от варианта и настроек чтения состояние ФН запрашивается в максимально полном виде.

Детализация чтения также может быть:
- ***Полной***. При этом из ФН считываются все основные текстовые (TLV) поля и квитанции подтверждения ОФД.
Может занимать продолжительное время. Наиболее старые версии ФН не поддерживают полную выгрузку.
- ***Краткой***. При этом считываются только суммовые счётчики, временны́е метки, номера, фискальные признаки
документов и состояния отправки ОФД. Выполняется быстрее полного считывания (примерно в два раза).

Работа программы протестирована на всех моделях ФН из [реестра ФНС](https://www.nalog.gov.ru/rn77/related_activities/registries/reestr_fiscal/).
При соблюдении производителями существующего аппаратного протокола чтения данных работа с будущими моделями ФН также будет возможна.
Поддержка версий ФФД 1.1 и более новых на данный момент находится в разработке; частичная поддержка уже доступна в релизной версии.

Для выполнения операций с ФН требуется наличие одного из следующих аппаратных адаптеров:
- COM-UART переходник для подключения ФН к разъёму COM (RS-232) компьютера;
- USB-VCOM-UART переходник для подключения к разъёму USB компьютера. В этом случае потребуется установить драйвера устройства;
инструкции и ссылки для их установки предоставляются производителями таких переходников.

Для работы модуля рекомендуется использовать операционную систему Windows 7 или более новую; функциональность приложения
на Windows XP не проверялась, но потенциально не ограничена. На ПК должна быть установлена среда
[.NET Framework 4.0](https://www.microsoft.com/ru-ru/download/details.aspx?id=17718) или более новая (обязательно при работе на Windows 7 и ниже).

> Обращаем внимание, что срок действия каждого релиза модуля ограничен с целью устранения устаревающих версий и обеспечения
> его постоянного соответствия актуальным изменениям в ФФД. Срок указан в заголовке операционного окна. По его истечении
> останутся доступными функции анализа ранее считанных данных. Для работы с новыми данными необходимо получить новый экземпляр приложения.

#

# 2. Начало работы (на примере VCOM-адаптера ООО «РИК»)

## 2.1. Подключение ФН и адаптера к ПК

Перед началом работы необходимо подготовить адаптер к работе. Порядок подключения следующий:
- Убедиться, что адаптер не подключён к ПК или другому источнику питания.
> Подключение и отключение ФН при наличии питания на адаптере может вывести оба устройства из строя!
- Подключить ФН к адаптеру. Обратите внимание на расположение «ключа» (пропущенного контактного штырька) на разъёмах ФН и адаптера.

![2](https://user-images.githubusercontent.com/20893717/147804726-54c1de33-80ed-4e46-a6a2-6ddd79aa4c51.png)

- Подключить адаптер к ПК.

Отключение по окончании работы с адаптером следует производить в обратном порядке:
- Отключить адаптер от ПК.
- Отключить ФН от адаптера.

> Отключение или переподключение адаптера при обращении к нему программы (определяется горящим или мигающим светодиодом
> на адаптере) запрещено! Это может вывести адаптер и ФН из строя!

Кроме того, при использовании USB-подключения для корректной и стабильной работы рекомендуются короткие соединительные
кабели (не длиннее 20 см) с сечением не менее 2,5 мм. Более длинные и/или тонкие кабели могут не обеспечивать достаточную
пропускную способность и/или уровень тока для некоторых моделей ФН (проверено на практике).

## 2.2. Установка драйвера устройства

После первого подключения адаптера к ПК может потребоваться установка драйвера. Драйвер для устройств FTDI VCP
доступен [здесь](http://www.ftdichip.com/Drivers/VCP.htm). Если драйвер упакован в архив, следует выполнить его распаковку в какую-либо папку.

Далее рассматривается установка драйвера на примере устройства FT230X Basic UART. Для установки драйвера необходимо выполнить следующие действия:
- В меню «Пуск» выбрать пункт «Выполнить» или нажать комбинацию клавиш [:window:] + [R].
- Ввести команду «compmgmt.msc» и нажать кнопку «ОК».
- В окне «Управление компьютером» в списке слева выбрать пункт «Диспетчер устройств». В списке устройств найти устройство «FT230X Basic UART»
(будет помечено значком ошибки).

![1](https://user-images.githubusercontent.com/20893717/147804389-f0a87ba5-cbd3-401e-825c-517af186607b.png)

- Щёлкнуть правой кнопкой мыши на этом устройстве и выбрать пункт «Обновить драйверы». В окне варианта установки выбрать «Выполнить поиск
драйверов на этом компьютере». В следующем окне нажать кнопку «Обзор» и указать папку, куда ранее были распакованы драйвера. Нажать кнопку «Далее».
- При необходимости проделать аналогичные манипуляции с устройством «USB Serial Converter» (если оно будет помечено значком ошибки).
- Найти в списке устройств раздел «Порты COM и LPT», а в нём – устройство «USB Serial Port». Запомнить номер порта; он потребуется для работы программы.

# 3. Работа с программой

С версии 7.7 модуль является частью инструмента [TextToKKT](https://github.com/adslbarxatov/texttokkt) для Windows. В его комплектацию
входят два файла – ```FNReader.dll``` и ```FNReaderLib.dll```. Отсутствие любого из них делает работу модуля невозможной. Запускать следует файл
```TextToKKT.exe```, из которого следует вызывать функцию FNReader.

Основной интерфейс модуля представлен на рисунке ниже.

![1](https://user-images.githubusercontent.com/20893717/147804740-130cdb1b-65f7-4892-9df3-9584e97a1b56.png)

## 3.1. Функции, доступные при запуске

- ***Выбрать номер порта подключения ФН***. Здесь необходимо выбрать порт, который соответствует устройству, появившемуся в системе
при установке драйверов (см. ранее). Если подключение устройства выполнено после запуска приложения, можно обновить список
системных портов ***кнопкой*** «✱».
- ***Подключить***. Запрашивает статус ФН и, если активен флажок «***и прочитать***» (будет иметь жёлтый цвет), запускает процесс
считывания данных из ФН. При этом будет отображено окно состояния чтения. На время считывания основное окно программы блокируется.
